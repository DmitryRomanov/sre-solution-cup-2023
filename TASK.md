# Задание 2 - Нетривиальный планировщик календаря работ

## Описание системы (сервиса)

В крупной ИТ-компании несколько дата центров, некоторые из которых состоят более чем из одной зоны доступности. В инфраструктуре большое количество сервисных направлений: сеть, СХД, виртуализация и т.д. В каждом сервисном направлении присутствует как автоматизация - регулярное выполнение небольших рутинных задач ботами, например, по cron расписанию, так и необходимость проведения работ в ручном режиме. Ручные работы требуют большого внимания, т.к. их проводят люди и работы могут как отменяться (человек заболел) или переноситься (бизнес решил провести распродажу), так и получать продления после начала (ребилд массива занял больше времени, чем ожидали). Важно планировать работы таким образом, чтобы они не пересекались между собой, не проводились сразу во всех зонах доступности и при этом учитывать необходимость наличия автоматизаций, запускающих свои задачи по расписанию, но также подчиняющихся общим ограничениям. Разработать алгоритм работы для такой системы - ваша задача.

На входе вы должны уметь получать заявки на проведение работ с указанием затрагиваемых зон доступности и желаемого интервала их проведения, а также сообщения об отменах или продлениях работ. На выходе должно получиться адаптивное расписание, в котором по возможности учтены все полученные заявки на проведение работ. Адаптивное в данном случае означает, что расписание должно перестраиваться с учетом всех поступающих изменений, но с минимальным влиянием на ранее полученные изменения. Красной звездочкой отмечены пункты повышенной сложности.

## Функциональные требования

### Конфигурация сервиса

Сервис управляется общим конфигом, в котором необходимо предусмотреть следующие опции для работы алгоритма планировщика:

1) Белый список: окна времени, в которые разрешено проведение работ в каждой из зон доступности.

2) Черный список: зоны доступности, в которых проведения любых работ кроме критичных полностью запрещено (имеет приоритет над белым списком).

3) Количество зон доступности, для которых в любой момент времени гарантировано, что в них не проводится никаких работ (зоны доступности из черного списка никогда не удовлетворяют этому условию).

4) (*) Паузы для каждой из зон доступности между работами, которые в ней будут проводиться.

Окна времени - интервал внутри дня длительностью от 1 часа до 24 часов. Число зон доступности - от 1 до N, где N <= 30. Количество зон, одновременно свободных от работ - от 0 до M, где M <= N. Длительность пауз всегда кратна 1 минуте - от 0 до 60 минут.

### Формат описания работ

Формат входного сообщения содержит следующие поля:

* желаемая дата и время начала работ;

* предполагаемая длительность работ;

* дедлайн - крайний срок, до которого надо провести работы;

* список зон доступности, в которых будут проводиться работы;

- тип работ:

    - автоматические - выполняются ботами, состоят из большого количества небольших атомарных действий, т.е. могут легко масштабироваться: передвигаться, сжиматься и т.п.

    -  ручные - выполняются людьми, как правило, по ночам, могут занимать достаточно много времени - почти не могут масштабироваться, только продляться;

- приоритет работ:

    - обычные - работы любого типа составляют около 99% всех работ;

    - критические - только ручные работы могут иметь данный приоритет. Все критические работы считаем равноценными между собой. Если случаются, то часто необходимо проведение сразу нескольких таких работ;

- только для автоматических работ: степень сжимаемости - процент максимально возможного уменьшения их длительности.

Минимальная длительность работ: 5 минут для автоматических и 30 минут для ручных. Максимальная длительность работ - 6 часов, для обычных работ любого типа и без ограничений для критических. Дедлайн не может превышать текущую дату более, чем на 4 недели. Желаемое время начала ручных работ кратно 5 минутам, автоматических - 1 минуте. Процент сжимаемости для автоматических работ - от 0% до 100%, но сжимать меньше минимальной длительности нельзя, ручние работы не сжимаются! * Все значения длительностей кроме процента сжимаемости вынести в конфиг и учитывать как динамические параметры при работе алгоритма.

Дополнительные сообщения бывают двух типов:

- отмена работ - может прийти в любой момент времени, в т.ч. и в момент их проведения. Применимо для работ любого типа. Отмененные работы не могут попасть в расписание, пока не будут присланы повторно;

- продление работ - может прийти только в момент их непосредственного проведения. Применимо только к работам ручного типа;

-  (*) перенос работ - эквивалентно ситуации отмены и повторного заведения с сохранением id, присвоенного при заведении.

### Требования к алгоритму

Алгоритм построения расписания должен:

1) Вести учет работ.

2) Перестраивать расписание проведения работ с учетом всех получаемых изменений.

3) Следить за изменениями конфигурации и при их выявлении также перестраивать расписание.

4) Гарантировать, что в одной зоне доступности в любой момент времени проводятся не более, чем одни работы.

5) Если работы в желаемое время не могут быть проведены сообщать об этом, предлагая несколько ближайших по времени вариантов с учетом окон времени из конфигурации сервиса.

6) При полной невозможности проведения работ сообщать об этом сообщением о невозможности при приеме заявки.

7) Критичные работы помещать в расписание вне очереди, принудительно отменяя обычные ручные работы и сжимая или перенося работы обычные автоматические. Однако даже критичные работы не могут отменить обычные работы, если они уже выполняются - необходимо дождаться их завершения.

8) При получении заявок на ручные работы отдавать им приоритет, отменяя работы автоматического типа. * По возможности, переносить и/или сжимать работы автоматического типа вместо отмены.

9) Предусматривать возможность получения неограниченного количества продлений для ручных работ любого приоритета. Продления не могут быть отменены алгоритмом, но во время действия продления возможно получение сообщения от пользователя об отмене уже начатых работ.

### Нефункциональные требования

Соблюдение этих требований является строго обязательным:

1) Решение должно использовать Apache License 2.0.

2) Владельцем прав должен быть банк Tinkoff.

3) В решении нельзя использовать несвободное программное обеспечение.

4) В решении нельзя использовать подключения к внешним сервисам в интернете и т.п., т.е. алгоритм должен быть полностью будет функционален в условиях запуска в изолированной среде. 

А соблюдение этих требований - очень желательным. В порядке приоритетов:

1) Полная устойчивость относительно конфигурации и списка работ. Ожидаем, что для одной и той же конфигурации с одним и тем же списком работ алгоритм будет выдавать всегда одинаковое расписание.

2) Частичная устойчивость относительно списка работ - ожидаем, что минимальные изменения в списке работ будут приводить к минимальным изменениям уже сформированного расписания.

3) Скорость работы - ожидаем, что на горизонте планирования в максимум в 4 недели алгоритм будет отрабатывать менее чем за 30 секунд для любого числа работ при выполнении на среднем современном CPU ноутбука/компьютера.

4) Потребление памяти - ожидаем, то алгоритм сможет работать на системах не более чем с 32 Гб RAM.

5) (*) Расширяемость - ожидаем, что введение новых правил для алгоритма или конфигурации, подобных тем, что уже введены, не потребует полной переработки алгоритма и не повлияют на его устойчивость.

6) Масштабируемость - ожидаем, что линейное увеличение горизонта планирования и числа работ не приведет, например, к экспоненциальному росту времени работы или потребления памяти.

7) Простота поддержки - ожидаем, что в реализации будут использованы хорошо известные языки программирования, библиотеки и базы данных.

8) Читаемость конфигурации - ожидаем, что это будет одновременно и человеко- и машиночитаемый формат.

9) Удобство работы - ожидаем, что взаимодействие с сервисом будет организовано с использованием современных средств и концепций построения API.

## Результаты работы системы (сервиса)

Конечный сервис должен включать в себя:

- настраиваемую конфигурацию в реальном времени конфигурацию;

- актуальный в текущий момент календарь проведения работ;

- актуальные в текущий момент статусы для каждого из поступивших запросов о проведении работ:

    - ожидают выполнения (если был перенос - с указанием нового времени начала);

    - выполняются (если было продление - с указанием нового времени окончания);

    - (*) перенесены (с указанием старого и нового времени);

    - (*) сжаты (с указанием процента сокращения длительности);

    - отменены (с обязательным указанием причины).
